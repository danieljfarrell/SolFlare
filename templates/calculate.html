{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efficiency Limit Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        #chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        #bandgap-line {
            position: absolute;
            width: 4px;
            background-color: rgb(255, 99, 132);
            top: 0;
            bottom: 20px;
            cursor: ew-resize;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #results {
            display: grid;
            grid-template-columns: auto auto;
            gap: 5px 20px;
            align-items: baseline;
        }
        #results h2 {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        #results p {
            margin: 0;
        }
        #results .value {
            justify-self: start;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="{% static 'unswlogo.png' %}" alt="UNSW Logo" height="50">
        <a href="http://www.solcore.solar"><img src="{% static 'solcore.png' %}" alt="Solcore Logo" height="50"></a>
    </div>

    <h1>Efficiency Limit Calculator</h1>

    <p>
        The efficiency limit is calculated using the Shockley-Queisser model implemented in
        <a href="http://www.solcore.solar">Solcore</a>. Drag the red line to change the bandgap
        and see how it affects the theoretical maximum efficiency of a single-junction solar cell.
    </p>

    <div id="chart-container">
        <canvas id="solar-spectrum"></canvas>
        <div id="bandgap-line"></div>
    </div>

    <div id="bandgap-value">Bandgap: 1.00 eV</div>

    <div id="results">
        <h2>Results</h2>
        <p>Efficiency</p><p class="value"><span id="efficiency">-</span>%</p>
        <p>V<sub>OC</sub></p><p class="value"><span id="voc">-</span> V</p>
        <p>J<sub>SC</sub></p><p class="value"><span id="jsc">-</span> mA/cm<sup>2</sup></p>
        <p>FF</p><p class="value"><span id="ff">-</span>%</p>
    </div>

    <script>
        const ctx = document.getElementById('solar-spectrum').getContext('2d');
        const bandgapValueDisplay = document.getElementById('bandgap-value');
        const bandgapLine = document.getElementById('bandgap-line');
        const chartContainer = document.getElementById('chart-container');
        const spectrumData = {{ spectrum_data|safe }};

        let bandgapEnergy = 1.0;
        const minEnergy = 0.3;
        const maxEnergy = 4.2;

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Solar Spectrum',
                    data: spectrumData,
                    borderColor: 'rgba(75, 192, 192, 0.8)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Energy (eV)'
                        },
                        min: minEnergy,
                        max: maxEnergy
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Spectral Irradiance (W/mÂ²/nm)'
                        },
                        min: 0
                    }
                },
                animation: {
                    duration: 0
                },
                maintainAspectRatio: false
            }
        });

        function updateBandgapLine(energy, calculateEfficiencyFlag = true) {
            const xScale = chart.scales.x;
            const pixelX = xScale.getPixelForValue(energy);
            bandgapLine.style.left = `${pixelX}px`;
            bandgapValueDisplay.textContent = `Bandgap: ${energy.toFixed(2)} eV`;
            if (calculateEfficiencyFlag) {
                calculateEfficiency(energy);
            }
        }

        function energyFromPixel(pixelX) {
            const xScale = chart.scales.x;
            return xScale.getValueForPixel(pixelX);
        }

         let isDragging = false;

        bandgapLine.addEventListener('mousedown', startDragging);
        chartContainer.addEventListener('mousedown', startDragging);

        function startDragging(e) {
            isDragging = true;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            e.preventDefault();
        }

        function onMouseMove(e) {
            if (!isDragging) return;
            const chartArea = chart.chartArea;
            const rect = ctx.canvas.getBoundingClientRect();
            const pixelX = e.clientX - rect.left;
            if (pixelX >= chartArea.left && pixelX <= chartArea.right) {
                let energy = energyFromPixel(pixelX);
                energy = Math.max(minEnergy, Math.min(maxEnergy, energy));
                bandgapEnergy = energy;
                updateBandgapLine(energy, false);  // Don't calculate efficiency while dragging
            }
            e.preventDefault();
        }

        function onMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                calculateEfficiency(bandgapEnergy);  // Calculate efficiency when dragging stops
            }
            e.preventDefault();
        }

        function calculateEfficiency(energy) {
            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ eg_value: energy })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('efficiency').textContent = data.efficiency.toFixed(2);
                document.getElementById('voc').textContent = data.voc.toFixed(2);
                document.getElementById('jsc').textContent = data.jsc.toFixed(2);
                document.getElementById('ff').textContent = data.ff.toFixed(2);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
            // Initialize bandgap line
        updateBandgapLine(bandgapEnergy);
    </script>
</body>
</html>